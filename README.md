# Project
주식회사 하이 - Admin용 데이터 관리 프로그램 만들기 

## 1. 프로젝트 소개

- 대표 관리자가 전국치매센터표준데이터 JSON 데이터 파일을 가지고 각 컬럼들을 파싱하여 데이터베이스에 저장 후,  
각 지역별 담당자들이 해당 지역에 속하는 데이터만을 조회하여 엑셀 파일로 다운로드 하려고 합니다.
- 어플리케이션 기능을 이용하기 위한 회원가입 기능부터 데이터베이스 저장 및 조회, 엑셀 다운로드까지의 모든 프로세스를 구현합니다.

## 2. 개발 기간 및 인원

- **개발 기간** : 2022.10.07 - 2022.10.09(3일)

- **인원** : 김민우, 이신희(PM), 오지호, 전은형, 홍현진

## 3. 프로젝트 실행 방법
```
# 깃허브에서 레포지토리 클론받기
$ git clone https://github.com/shlee2227/PreOnBoarding_2nd_Haii.git

# 해당 디렉토리로 이동
$ cd PreOnBoarding_2nd_Haii

# 패키지 설치
$ npm install

# .env파일 만들기
DATABASE_URL = mysql://USERNAME:PASSWORD@127.0.0.1:3306/DATABASE
TYPEORM_CONNECTION = mysql
TYPEORM_HOST = 127.0.0.1
TYPEORM_PORT = 3306
TYPEORM_USERNAME = 계정
TYPEORM_PASSWORD = 비밀번호
TYPEORM_DATABASE = 데이터베이스 이름

SECRET_KEY = 시크릿키
ISSUER = 배포자

# 데이터베이스 테이블 생성
$ dbmate up

# 프로젝트 실행
$ npm start

# server start : http://localhost:8000
```

## 4. 데이터 모델링
▶️ [dbdiagram Link](https://dbdiagram.io/d/633f85a1f0018a1c5fb1efa3)

![image](https://user-images.githubusercontent.com/78359232/194761953-848c413e-bf18-479a-a45e-60b0d34250dd.png)

## 5. 프로젝트 구조
```
.
├── README.md
├── apidocs
├── app.js
├── controllers
├── data.json
├── db
├── middlewares
├── models
├── node_modules
├── package-lock.json
├── package.json
├── routes
├── server.js
├── services
└── utils
```

## 6. 구현 기능 설명

### 1) 회원가입 (김민우)
  - 구현 기능 설명
    - Request body를 통해 전달받은 정보로 USER를 생성합니다.
    - 정규식를 사용하여 전달받은 각각의 파라미터들에 대한 유효성을 검증합니다.
    - bcryptjs 라이브러리를 사용해 비밀번호를 암호화하여 데이터에 저장합니다.
    - 입력된 값이 없는 파라미터가 있을 경우 에러를 반환합니다.(담당지역 제외)
    - 데이터베이스에 중복된 account가 존재할 경우 에러를 반환합니다.
    - 대표관리자로 가입을 할 경우 담당 지역 입력시 에러를 반환합니다.
    - 데이터 내 담당지역id 값이 없는 값을 입력하면 에러를 반환합니다.
    
  - 기능 구현 시 어려웠던 점과 그에 대한 해결 방안을 모색하기 위해 노력한 점
    - 회원가입시 생길 수 있는 예상가능한 문제들에 대해 충분히 에러처리를 하였다고 생각하였는데, 뒤늦게 놓치는 부분이 발생되어 수정하였습니다.
    - 대표관리자의 경우 담당지역을 갖지 않는다는 부분의 구현을 위해  
      type_id 1번을 대표 담당자 / 2번을 지역별 관리자로 구분하여    
      if (type_id === 1 && region_id) 대표관리자와 담당지역이 같이 전달될 경우 에러를 반환하고,  
      if (type_id === 2 && !checkExistRegionId) 지역별관리자는 담당지역이 없는 값이 함께 전달될 경우 에러를 반환하였습니다.
    - 각각의 파라미터마다 다양한 방법으로 유효성 검사가 진행되어야하고, 특히 사용하는 기능에 맞는 에러 처리를 위해 충분한 대비 및 테스트가 필요하다는 점을 알게되었습니다.

### 2) 로그인 (홍현진)
  - API 사용법
    - 아이디(account)와 패스워드(password)를 request body에 담아 로그인을 요청한다.
    - 둘 중 하나라도 누락 시 400 에러 / message: "이메일과 비밀번호를 모두 입력해주세요."
    - 둘 중 하나라도 DB와 일치하지 않을 경우 404 에러 / message: "이메일과 비밀번호를 확인해주세요."
    - 로그인 성공 시 Access Token과 Refresh Token을 하나의 변수 Token에 배열로 담아서 발행. 
    
  - 선택 사항 구현 시, 구현 방법과 이유에 대한 간략한 설명
    - Access Token은 만료시간 짧게(1시간) , Refresh Token은 만료시간을 좀 더 길게(14일) 설정하면 토큰이 탈취 당했을 경우에 대한 위험성을 낮추면서 사용자의 불편을 최소화할 수 있다.
    - Refresh Token은 payload에 정보를 담지 않고 검증만 할 수 있도록 발행한다. 이를 통해 토큰 사용 시 Access Token이 만료된 경우 Refresh Token을 추가로 받아서 검증하고 Refresh Token이 만료되지 않은 경우 Access Token을 새로 발급하여 안전하게 토큰을 활용할 수 있다.
    
  - 기능 구현 시 어려웠던 점과 그에 대한 해결 방안을 모색하기 위해 노력한 점
    - Refresh Token 구현 : 우선 Refresh Token의 필요성과 로직을 먼저 이해해야 했다. 구글링으로 찾은 여러 참고 자료를 확인하고 이를 바탕으로 스스로 로직을 작성하고 테스트하며 기능을 구현했다.
    - Swagger 사용 : Swagger로 API 문서화 작업을 하는 것이 처음이라 초반 세팅을 위해 “swagger express”를 정말 많이 검색했다. 여러 블로그와 공식 문서에 잘 정리되어 있었지만, 각 정보마다 세팅 방식이 다르고 로직이 이해가 잘되지 않아서 기능 구현보다 더 많은 시간을 할애했다. 생각보다 첫 설정이 많이 어려웠지만 팀원들의 도움으로 무사히 Swagger를 사용하여 API 문서화를 완성할 수 있었다.

### 3) 회원 정보 수정(전은형)
  - 구현 기능 설명
    - 대표 관리자는 자신 또는 지역별 담당자의 이름, 전화번호, 담당 지역을 수정할 수 있습니다.
    - put을 사용할 시 보내지 않은 데이터는 null값으로 업데이트 되기 떄문에 patch 메소드를 선택했습니다.
    - 수정할 유저 id는 path parameter 로, 수정할 데이터 name / phone_number / region_id는 body로 받습니다.
    - 로그인한 유저가 대표 관리자인지 파악하기 위해 토큰의 페이로드에 type_id를 추가했습니다.
    - type_id 1번을 대표 관리자로 정했습니다.
    - 로그인한 유저의 type_id가 1이 아니면 회원 정보 수정 권한이 없으므로 403 에러를 반환합니다.
    - 로그인한 유저의 type_id가 1이라면 추가 테스트를 진행합니다.
      - 수정 불가한 account(아이디), password(비밀번호)를 수정하려고 하면 400 에러를 반환합니다.
      - name, phone_number, region_id만 수정 가능합니다.
      - name과 phone_number는 유효성 검사를 통과해야합니다.
      - region_id가 DB에 저장된 지역 ID가 아니라면 404 에러를 반환합니다.
      - path parameter로 전달받은 수정할 유저 id가 DB에 저장된 유저 ID가 아니라면 404 에러를 반환합니다.
      - 기존 데이터베이스에 저장된 값과 동일할 값으로 수정할 경우 400 에러를 반환합니다.
    - 위의 모든 테스트를 통과하면 해당 데이터 수정에 성공합니다.
    
  - 선택 사항 구현 시, 구현 방법과 이유에 대한 간략한 설명
    - 가입일시는 데이터베이스에 저장된 시간을 기록해야 하고, 수정일시는 업데이트된 시간을 기록해야합니다.
    - 이를 반영하기 위해 컬럼을 정의할 때 아래와 같은 옵션을 추가했습니다.
      ```
      created_at DATETIME DEFAULT NOW(),
      updated_at DATETIME DEFAULT NOW() ON UPDATE CURRENT_TIMESTAMP,
      ```
      
  - 기능 구현 시 어려웠던 점과 그에 대한 해결 방안을 모색하기 위해 노력한 점
    - 업데이트 기능을 구현하기 위해 많은 예외처리가 필요했습니다.
    - 꼼꼼하게 에러를 처리하고 싶어서 나만의 flow chart를 그림으로 그렸고 흐름에 따라 코드를 작성했습니다.
    - 스웨거를 적용시키는 부분이 낯설고 어려웠지만 공식 문서와 팀원분이 공유주신 swagger editor 홈페이지의 도움을 받아 작성했습니다.
      
### 4) JSON 데이터 파싱 후 데이터베이스 저장(오지호)
  - 구현 기능 설명
    - 대표관리자 권한을 토큰을 이용하여 확인합니다.
    - 대표관리자 권한이 없다면 데이터 입력이 불가능합니다.
    - 데이터는 다운로드한 JSON파일 기준으로 입력됩니다.
    - 각 테이블당 필요한 데이터 입력을 위하여 새로운 배열에 데이터를 중복값 없이 정리합니다.
    - 테이블 column에 맞게 데이터를 입력합니다. FOREIGN KEY 또한 일치하는 ID값을 입력합니다.
    - 같은 데이터 추가 입력 시도 시, 데이터베이스에 추가되지 않습니다.

  - 선택 사항 구현 시, 구현 방법과 이유에 대한 간략한 설명
    - 저희 팀 DB 구조 특성상 모든 데이터가 한 테이블에 존재하지 않기 때문에 미리 받아온 데이터를 각 테이블에 맞춰 데이터 정리가 필요하여 기본데이터, 운영데이터, 관리데이터, 제공기관데이터 총 4가지 데이터set을 new Set, JSON.map, JSON.parse를 이용하여 만들었습니다.
    - FOREIGN KEY 연결 문제 해결을 위하여 운영데이터, 관리데이터, 제공기관데이터를 먼저 입력하도록 코드를 작성하였고, 중복값은 들어가지 않도록 작성하였습니다.
    - 만약에 같은 request를 보내더라도, 동일한 데이터가 들어가지 않도록 중복체크를 하여 새로운 데이터만 들어가도록 구현하였습니다 (MYSQL의 WHERE NOT EXIST 이용).
    
  - 기능 구현 시 어려웠던 점과 그에 대한 해결 방안을 모색하기 위해 노력한 점
    - 데이터를 분리하여 중복값을 처리하는 부분은 처음 접해봤는데 “배열 데이터 중복 값 제거“, “JSON 데이터 관리” 등 검색 및 MDN WEB DOCS에 있는 JSON.PARSE, MAP, REDUCE등 참조하여 기능구현을 하였습니다. BLOCKER라고 할만한 사항은 없었기 때문에 쉽지는 않았지만 중간중간 생기는 작은 문제들을 잘 해결한 것 같습니다.

### 5) 엑셀 다운로드 기능(이신희)
  - 구현 기능 설명
    - 사용자의 담당 지역에 대한 데이터를 조회하여 엑셀 파일로 다운로드 받습니다.
    - 대표 관리자는 모든 데이터에 접근 할 수 있습니다.
    - 조건에 맞는 데이터를 검색할 수 있습니다.
      >전체 데이터 조회 [GET] localhost:8000/download
      >
      >검색 데이터 조회 [GET] localhost:8000/download/search?key=value

      | key | value | example |
      | ------ | ------ | ----- |
      | 치매센터명 | string | 서울 (치매센터명에 ‘서울‘이 포함된 경우를 검색) |
      | 운영기관대표자명 | string | 보건소장 (운영기관대표자명에 ‘보건소장‘이 포함된 경우를 검색) |
      | 운영기관전화번호 | string | 031 (운영기관전화번호에 ‘031’이 포함된 경우를 경색) |
      | 치매센터유형 | integer | 1 (광역치매센터), 2 (치매상담전화센터), 3(치매안심센터) |
      | 의사인원수 | integer | 1 (의사인원수가 1 이상인 경우를 검색) |
      | 간호사인원수 | integer | 1 (간호사인원수가 1 이상인 경우를 검색) |
      | 사회복지사인원수 | integer | 1 (사회복지사인원수가 1 이상인 경우를 검색) |
      
  - 선택 사항 구현 시, 구현 방법과 이유에 대한 간략한 설명
    - Mysql을 연동하여 SQL을 사용하여 데이터를 받아오고, 받아온 데이터를 exceljs를 사용하여 엑셀파일로 내보냈습니다.
    - 생성된 엑셀파일을 정적파일 serve를 위한 폴더인 ./public 폴더에 저장하고 각 API 마지막에 client로 전송합니다.
    - SQL문에 의한 오류를 최소화 하기 위해 검색조건이 있는 경우와 없는 경우를 구분하여 API를 작성하였습니다.
    - 중복되는 기능 (유저 정보 받아오기, 토큰 verify 등)은 개별 함수 혹은 미들웨어 형태로 작성하여 필요한 경우에 가져다 사용하여 코드 낭비를 최대한 줄이고자 했습니다.
    - 검색 url (/download/search)로 접근하였으나 아무 parameter를 보내지 않은 경우에는 오류 대신 기본 url (/download)로 리다이렉트 하여 사용자 편의성을 높였습니다.
    
  - 기능 구현 시 어려웠던 점과 그에 대한 해결 방안을 모색하기 위해 노력한 점
    - 완전히 처음 만들어보는 기능이라 개념 파악에 시간이 많이 소요되었습니다.
    - exceljs의 공식 문서와 관련 github repository를 읽으며 작업했고 정적 파일 serve APP을 만들기 위해 생활코딩 유튜브를 참고했습니다.
    - 엑셀파일이 깨진 상태로 client로 전달되는 문제가 있었고 이를 해결하기 위해 몇시간동안 코드를 처음부터 끝까지 하나하나 콘솔로 찍어보면서 분석했습니다. 엑셀 파일 생성 로직에 await를 추가하면서 해결하였고 동기/비동기 개념에 대해 좀 더 학습하는 계기가 되었습니다.
    - 검색을 위한 SQL문 작성에서 한번의 요청으로 데이터를 받아올 수 있도록 각 검색조건의 존재 유무에 따라 SQL문 자체의 구조가 달라지게 구성하였습니다. string 타입의 변수는 ‘string’ 형태로 제공되어서 이를 escape 하기위해 SQL을 따로 선언하여 concat을 사용하여 사용하였습니다. 많은 변수를 동시에 컨트롤 하는 경험이 되었습니다.

## 6. API Docs
```
# 서버 켜기
$ node server.js

# 스웨거 url 입력
http://127.0.0.1:8000/api-docs

```
▶️ [Swagger](http://127.0.0.1:8000/api-docs)
<img width="1542" alt="스크린샷 2022-10-10 오전 1 25 11" src="https://user-images.githubusercontent.com/78359232/194768171-fd580a64-df41-4435-ae0d-88458333f7ef.png">



